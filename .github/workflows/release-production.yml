name: Release Production

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
          - pre-release
      pre_release:
        description: 'Pre-release identifier (optional, e.g., "beta", "rc1")'
        required: false
        type: string
      release_notes:
        description: "Release notes / What's Changed (optional)"
        required: false
        type: string

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository 🛎️
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Python 🐍
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Configure Git 🔧
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Install dependencies 📦
        run: |
          pip install pipenv
          pipenv install --dev

      - name: Bump version 🏷️
        run: |
          if [ "${{ inputs.version_type }}" = "pre-release" ]; then
            python scripts/bump_version.py -p "${{ inputs.pre_release }}" -v
          else
            python scripts/bump_version.py -t ${{ inputs.version_type }} -v
          fi

      - name: Get new version 📋
        id: get_version
        run: |
          VERSION=$(grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+[^" ]*' src/constants.py | head -1)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "New version: $VERSION"

      - name: Commit version changes 💾
        run: |
          git add src/constants.py
          git commit -m "chore: bump version to $(echo '${{ steps.get_version.outputs.version }}' | sed 's/:.*//')"

      - name: Create Git tag 🏷️
        run: |
            git tag "$(echo '${{ steps.get_version.outputs.version }}' | sed 's/:.*//')"

      # no testing for now
      # - name: Run tests 🧪
      #   run: |
      #     # pipenv run pytest
      
      - name: Build and package server 🏗️
        run: |
          tar -czf arpi-server-${{ steps.get_version.outputs.version }}.tar.gz --exclude='__pycache__' --exclude='*.pyc' src/

      - name: Push changes and tags 🚀
        run: |
          git push origin master
          git push origin ${{ steps.get_version.outputs.version }}

      - name: Create GitHub Release 📦
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_version.outputs.version }}
          name: Release ${{ steps.get_version.outputs.version }}
          draft: false
          prerelease: ${{ inputs.version_type == 'pre-release' }}
          generate_release_notes: true
          files: |
            arpi-server-${{ steps.get_version.outputs.version }}.tar.gz
          body: |
            ## What's Changed

            ${{ inputs.release_notes || 'This release includes the latest changes from the master branch.' }}

            ### Installation

            Download the `arpi-server-${{ steps.get_version.outputs.version }}.tar.gz` file and extract it to your server directory.

            ### Build Information
            - **Version**: ${{ steps.get_version.outputs.version }}
            - **Branch**: ${{ github.ref_name }}
            - **Build Date**: ${{ github.run_started_at }}
            - **Commit**: ${{ github.sha }}
            - **Workflow Run**: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Upload build artifacts 📤
        uses: actions/upload-artifact@v4
        with:
          name: production-build-${{ steps.get_version.outputs.version }}
          path: |
            arpi-server-${{ steps.get_version.outputs.version }}.tar.gz
          retention-days: 30
